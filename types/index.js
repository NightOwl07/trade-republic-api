// @bun
import*as x from"readline";import*as m from"fs/promises";import*as u from"path";import*as M from"os";function f(n,t){return{type:n,...t}}import{WebSocket as a}from"ws";var P=".tr_api_cookies.json",c=1e4,p=7000,h=30000,v=1e4;class l{phoneNo;pin;static HOST="https://api.traderepublic.com";static WS_HOST="wss://api.traderepublic.com";static WS_CONNECT_VERSION="31";ws;trSessionToken;trRefreshToken;rawCookies=[];processId;subscriptions=[];nextSubscriptionId=1;echoIntervalId;cookieFilePath;reconnectAttempts=0;pendingSubs=[];constructor(n,t,i){this.phoneNo=n;this.pin=t;if(i)this.cookieFilePath=u.resolve(i);else this.cookieFilePath=u.join(M.homedir(),P)}async login(n=this._askDevicePinFromStdin){console.info("Attempting to log in...");try{if(await this.loadAndValidateSavedSession())return console.log("Successfully logged in using saved session. WebSocket setup completed."),!0;console.info("Saved session invalid or not found. Performing full login...");let t=await this._performInitialLoginStep();if(!t.processId)throw new Error("Login failed: no processId received from initial login step.");this.processId=t.processId;let i=await n();return await this._verifyDevicePin(i),await this._saveSessionToFile(),await this._setupWebSocket(),console.log("Login successful via full flow and WebSocket setup completed."),!0}catch(t){return console.error("Login failed:",t instanceof Error?t.message:t),await this._clearSessionAndConnection(!1),!1}}async _performInitialLoginStep(){let n=await this._request("/api/v1/auth/web/login",{phoneNumber:this.phoneNo,pin:this.pin});if(!n.ok){let t=await n.text();throw new Error(`Initial login request failed with status ${n.status}: ${t}`)}return await n.json()}async _verifyDevicePin(n){if(!this.processId)throw new Error("Cannot verify PIN without a processId. Login flow corrupted.");let t=await this._request(`/api/v1/auth/web/login/${this.processId}/${n}`);if(!t.ok){let r=await t.text();throw new Error(`Device PIN verification failed with status ${t.status}: ${r}`)}let e=t.headers.getSetCookie?.bind(t.headers);if(typeof e==="function")this.rawCookies=e();else{let r=t.headers.get("set-cookie");this.rawCookies=r?r.split(/,(?=\s*[A-Za-z0-9_\-]+=)/g):[]}if(this.trSessionToken=this._extractCookieValue("tr_session",!0),this.trRefreshToken=this._extractCookieValue("tr_refresh",!1),!this.trSessionToken)throw new Error("Critical: tr_session token not extracted after PIN verification.")}async _setupWebSocket(){if(this.ws&&this.ws.readyState===a.OPEN){console.info("WebSocket already connected.");return}await this._closeWebSocket(),this._clearEchoInterval(),console.info(`Attempting to connect to WebSocket at ${l.WS_HOST}`),this.ws=new a(l.WS_HOST),await new Promise((n,t)=>{let i=setTimeout(()=>{this.ws?.removeAllListeners(),this.ws?.terminate(),this.ws=void 0,t(new Error(`WebSocket connection timed out after ${c/1000}s`))},c),e=()=>{clearTimeout(i),this.ws?.off("error",s),console.info("WebSocket connection opened.");let y={locale:"en"};this.ws.send(`connect ${l.WS_CONNECT_VERSION} ${JSON.stringify(y)}`),this._startEcho(),this.reconnectAttempts=0,this._flushPendingSubs(),this._resubscribeAll(),n()},r=(y)=>{this._handleWebSocketMessage(y.toString())},g=(y,o)=>{console.info(`WebSocket connection closed. Code: ${y}, Reason: ${o.toString()}`),this._clearEchoInterval(),this._scheduleReconnect()},s=(y)=>{clearTimeout(i),this.ws?.off("open",e),this.ws?.off("message",r),console.error("WebSocket setup error:",y.message),this.ws?.terminate(),this.ws=void 0,this._scheduleReconnect(),t(y)};this.ws?.once("open",e),this.ws?.on("message",r),this.ws?.once("error",s),this.ws?.once("close",g)})}async _closeWebSocket(){if(this._clearEchoInterval(),this.ws){let n=this.ws.readyState;if(n===a.OPEN||n===a.CONNECTING){console.info("Closing WebSocket connection..."),this.ws.removeAllListeners();let t=new Promise((i)=>{this.ws.once("close",()=>{console.info("WebSocket connection confirmed closed."),i()}),this.ws.close()});await Promise.race([t,new Promise((i)=>{setTimeout(()=>{if(this.ws&&this.ws.readyState!==a.CLOSED)console.warn("WebSocket close timed out, terminating."),this.ws.terminate();i()},2000)})])}else if(n===a.CLOSING)await new Promise((t)=>this.ws.once("close",t));this.ws=void 0}}async _request(n,t=null,i="POST",e=!1){let r={"Content-Type":"application/json"};if(e&&this.rawCookies.length>0)r.Cookie=this.rawCookies.map((o)=>o.split(";")[0]).join("; ");let g={method:i,headers:r,body:i==="GET"||i==="DELETE"||!t?void 0:JSON.stringify(t)},s=new AbortController,y=setTimeout(()=>s.abort(),v);try{return await fetch(`${l.HOST}${n}`,{...g,signal:s.signal})}finally{clearTimeout(y)}}_askDevicePinFromStdin=async()=>{let n=x.createInterface({input:process.stdin,output:process.stdout});return new Promise((t)=>{n.question("Please enter the PIN received on your phone: ",(i)=>{n.close(),t(i)})})};_extractCookieValue(n,t=!0){let r=this.rawCookies.join("; ").match(new RegExp(`(?:^|;)\\s*${n}=([^;]+)`))?.[1];if(!r&&t)throw new Error(`Required cookie not found: ${n}`);return r}subscribe(n,t){return this._subscribeInternal(n,t,!1)}subscribeOnce(n,t){return this._subscribeInternal(n,t,!0)}unsubscribe(n){if(this.subscriptions=this.subscriptions.filter((t)=>t.id!==n),this.ws&&this.ws.readyState===a.OPEN)try{this.ws.send(`unsub ${n}`)}catch(t){console.warn("Failed to send unsub:",t.message)}}_subscribeInternal(n,t,i){if(!this.trSessionToken)return console.error("Session token is not available. Cannot subscribe."),-1;let e=this.nextSubscriptionId++,r=()=>{if(!this.ws||this.ws.readyState!==a.OPEN){console.error("WebSocket connection not established or not open. Cannot subscribe now.");return}try{this.ws.send(`sub ${e} ${JSON.stringify({token:this.trSessionToken,...n})}`)}catch(g){console.error("Failed to send subscription:",g instanceof Error?g.message:g)}};if(this.subscriptions.push({id:e,topic:n.type,payload:n,callback:t,isOneTime:i}),this.ws?.readyState===a.OPEN)r();else this.pendingSubs.push(r);return e}_flushPendingSubs(){if(!this.pendingSubs.length)return;let n=this.pendingSubs.splice(0);for(let t of n)try{t()}catch(i){console.warn("Error flushing pending subscription:",i.message)}}_resubscribeAll(){if(!this.ws||this.ws.readyState!==a.OPEN)return;for(let n of this.subscriptions)try{this.ws.send(`sub ${n.id} ${JSON.stringify({token:this.trSessionToken,...n.payload})}`)}catch(t){console.warn(`Failed to resubscribe ${n.id}:${n.topic}`,t.message)}}_scheduleReconnect(){let n=Math.min(30000,1000*2**this.reconnectAttempts++);setTimeout(async()=>{try{await this._setupWebSocket()}catch{}},n)}_startEcho(){if(this.echoIntervalId)clearInterval(this.echoIntervalId);this.echoIntervalId=setInterval(()=>this._sendEcho(),h)}_clearEchoInterval(){if(this.echoIntervalId)clearInterval(this.echoIntervalId),this.echoIntervalId=void 0}_sendEcho(){if(!this.ws||this.ws.readyState!==a.OPEN){console.warn("Cannot send echo, WebSocket not open.");return}try{let n=`echo ${Date.now()}`;this.ws.send(n)}catch(n){console.error("Failed to send echo:",n instanceof Error?n.message:n)}}_handleWebSocketMessage(n){if(n.startsWith("echo"))return;if(n.startsWith("connected")){console.info("WebSocket acknowledged connection:",n);return}let t=this._parseWebSocketPayload(n);if(!t)return;let{subscriptionId:i,jsonData:e}=t;if(i===null){if(n.includes("failed")||n.includes("error"))console.warn("Received unhandled or general error message from WebSocket:",n);return}let r=this.subscriptions.findIndex((g)=>g.id===i);if(r!==-1){let g=this.subscriptions[r];try{g.callback(e)}catch(s){console.error(`Error in subscription callback for ID ${i}, topic ${g.topic}:`,s instanceof Error?s.message:s)}if(g.isOneTime)this.subscriptions.splice(r,1)}}_parseWebSocketPayload(n){let t=n.indexOf("{");if(t!==-1){let e=n.substring(0,t).trim().match(/\d+/),r=e?Number(e[0]):null,g=n.substring(t).trim();return{subscriptionId:r,jsonData:g}}else return{subscriptionId:null,jsonData:null}}async _saveSessionToFile(){if(this.trSessionToken&&this.rawCookies.length>0){let n={trSessionToken:this.trSessionToken,trRefreshToken:this.trRefreshToken,rawCookies:this.rawCookies};try{await m.mkdir(u.dirname(this.cookieFilePath),{recursive:!0}),await m.writeFile(this.cookieFilePath,JSON.stringify(n,null,2),{encoding:"utf-8",mode:384}),console.info("Session data saved to:",this.cookieFilePath)}catch(t){console.error("Error saving session data to file:",this.cookieFilePath,t)}}else console.warn("No session token or raw cookies to save. Skipping save.")}async _loadSessionFromFile(){try{await m.access(this.cookieFilePath)}catch(n){if(n.code==="ENOENT")console.info("Session file not found. A new session will be created if login proceeds.");else console.warn("Error accessing session file (permissions?):",this.cookieFilePath,n.message);return null}try{let n=await m.readFile(this.cookieFilePath,"utf-8");if(!n.trim())return console.warn("Session file is empty. Will be overwritten on next successful login."),await this._deleteSavedSessionFile(),null;let t=JSON.parse(n);if(t.trSessionToken&&Array.isArray(t.rawCookies))return console.info("Session data loaded from:",this.cookieFilePath),t;return console.warn("Loaded session file is malformed (missing token or rawCookies). It will be overwritten."),await this._deleteSavedSessionFile(),null}catch(n){return console.warn("Error loading/parsing session data from file:",this.cookieFilePath,n.message),await this._deleteSavedSessionFile(),null}}async loadAndValidateSavedSession(){let n=await this._loadSessionFromFile();if(!n?.trSessionToken)return!1;this.trSessionToken=n.trSessionToken,this.trRefreshToken=n.trRefreshToken,this.rawCookies=n.rawCookies,console.info("Loaded session from file. Validating session via WebSocket...");try{if(await this._setupWebSocket(),!this.ws||this.ws.readyState!==a.OPEN)return console.warn("WebSocket not open after setup attempt during saved session validation."),await this._clearSessionAndConnection(!0),!1;if(await this._performSessionValidationSubscription())return console.info("Saved session is valid and WebSocket is ready."),!0;else return console.warn("Saved session validation failed (token likely expired or invalid)."),await this._clearSessionAndConnection(!0),!1}catch(t){return console.warn("Error during saved session validation or WebSocket setup:",t.message||t),await this._clearSessionAndConnection(!0),!1}}_performSessionValidationSubscription(){let n=f("availableCash");return new Promise((t)=>{let i=null,e=!1,r=(g)=>{if(e)return;if(e=!0,i)clearTimeout(i),i=null;t(g)};try{this.subscribeOnce(n,(g)=>{if(g===null){console.warn("Session validation subscription received null data string. Assuming invalid."),r(!1);return}try{if(g.includes("AUTHENTICATION_ERROR"))console.warn("Session validation subscription indicated an error:",g),r(!1);else console.info("Session validation subscription successful."),r(!0)}catch(s){console.warn("Error parsing payload during session validation:",s instanceof Error?s.message:s,"Raw data:",g),r(!1)}})}catch(g){console.error("Error initiating session validation subscription:",g instanceof Error?g.message:g),r(!1)}i=setTimeout(()=>{if(!e)console.warn(`Session validation subscription timed out after ${p/1000}s.`),r(!1)},p)})}async _clearLocalRuntimeState(){console.debug("Clearing local runtime state..."),this.trSessionToken=void 0,this.trRefreshToken=void 0,this.rawCookies=[],this.processId=void 0,this.subscriptions=[],this.nextSubscriptionId=1,this.pendingSubs=[],await this._closeWebSocket()}async _deleteSavedSessionFile(){try{await m.access(this.cookieFilePath),await m.unlink(this.cookieFilePath),console.info("Saved session file deleted:",this.cookieFilePath)}catch(n){if(n.code==="ENOENT");else console.error("Error deleting saved session file:",this.cookieFilePath,n.message)}}async _clearSessionAndConnection(n){if(await this._clearLocalRuntimeState(),n)await this._deleteSavedSessionFile()}async logout(){console.info("Logging out and clearing session..."),await this._clearSessionAndConnection(!0),console.info("Local session cleared, saved session file deleted, and WebSocket closed.")}}export{f as createMessage,l as TradeRepublicApi};
